---
layout:     post
title:      Fortran 并行计算二三事
subtitle:   在天河计算机上运行
date:       2021-12-16
author:     Rain Chen
header-img: img/posts.png
catalog: true
tags:
    - 开发与应用
---

# Fortran 并行计算二三事

## MPI 使用概述

MPI 消息传递接口。多台机器同时计算时，一边计算一边传递信息。同一个程序，在每一个节点上运行一个进程。

```fortran
include 'mpif.h'
integer b, y, ierr, myid, num, status(mpi_status_size), j2
call mpi_init(ierr)
call mpi_comm_rank(mpi_comm_world, myid, ierr)
call mpi_comm_size(mpi_comm_world, num, ierr)
call mpi_bcast(dmbig, i, mpi_logical, 0, mpi_comm_world, ieer)
call mpi_barrier(mpi_comm_world, ieer)
call mpi_barrier(mpi_comm_world, ieer)
call mpi_recv(delta1, 1, mpi_double_precision, 1, 0, mpi_comm_world, status, ieer)
call mpi_send(delta, 1, mpi_double_precision, 0, 0, mpi_comm_world, ieer)
call mpi_finalize(ieer)
```

Fortran90 以上支持并行计算，子程序。

```fortran
call mpi_init(ierr)
```

初始化。

```fortran
call mpi_barrier(mpi_comm_world, ieer)
```

等所有的节点都执行到这一句之后，接下来才继续执行。

```fortran
call mpi_recv(delta1, 1, mpi_double_precision, 1, 0, mpi_comm_world, status, ieer)
call mpi_send(delta, 1, mpi_double_precision, 0, 0, mpi_comm_world, ieer)
```

向其他节点发送以及从其他节点接受消息，用于同步数据。

## 编译含有 MPI 的并行计算程序

编译，可以使用 GCC 或者 Intel 的编译器，建议使用 Intel 的 ifort。
编译前需要使用命令方式配置编译环境。配置方法：在天河计算机上执行下面指令。

```shell
source /opt/intel/Compiler/11.1/059/bin/intel64/iccvars_intel64.sh
source /opt/intel/Compiler/11.1/059/bin/intel64/ifortvars_intel64.sh
```

或者

```shell
source /vol6/appsoftware/intel/11.1/059/bin/intel64/iccvars_intel64.sh
source /vol6/appsoftware/intel/11.1/059/bin/intel64/ifortvars_intel64.sh
```

把 Fortran90 源文件上传至天河机之后，使用合适的 MPI 编译器编译。

```shell
mpif90 <源程序.f90> -o <编译完成后的程序名>
```

例如：

```shell
mpif90 expmtt.f90 -o cyrain
```

## 实际操作

「纸上得来终觉浅，绝知此事要躬行。」

### 例子

对 8 * 8 的矩阵进行转置，使用四台机器。mat01.txt, mat02.txt, mat03.txt, mat04.txt 四块 4 * 4 的矩阵。下面是用于测试的源代码。

```fortran
program main
    include 'mpif.h'
    character *(3) fname
    dimension mymat (4, 4), mytmat(4, 4), mymatr(4, 4)
    integer mymat, mytmat, mymatr
    integer ierr, myid, num, status(mpi_status_size)
    call mpi_init(ierr)
    call mpi_comm_rank(mpi_comm_world, myid, ierr)
    call mpi_comm_size(mpi_comm_world, num, ierr)
    fname = 'mat'
    open(1, file = fname//char(48 + myid)//'1.txt', status = 'old')
    open(2, file = fname//char(48 + myid)//'2.txt', status = 'new')

    if (myid .eq. 0) then
        write(2, *) 'The primary process'
        write(2, *) 'myid =', myid
        write(2, *) 'number of processors =', num
    else
        write(2, *) 'An assistance process'
        write(2, *) 'myid =', myid
        write(2, *) 'number of processors =', num
    end if

    do i = 1, 4
        read(1, 100) (mymat(i, j), j = 1, 4)
    end do
    100 format(4i5)
    call mpi_barrier(mpi_comm_world, ierr)
    ! Wait for end of read data from file 1, part of the total 8*8 matrix
    if ((myid .eq. 0) .or. (myid .eq. 3)) then
        do i = 1, 4
            do j = 1, 4
                mytmat(i, j) = mymat(j, i)
            end do
        end do
    else
        if (myid .eq. 1) then
            call mpi_send(mymat, 16, mpi_integer, 2, 0, mpi_comm_world, ierr)
            call mpi_recv(mymatr, 16, mpi_integer, 2, 0, mpi_comm_world, status, ierr)
        else
            if (myid .eq. 2) then
                call mpi_send(mymat, 16, mpi_integer, 1, 0, mpi_comm_world, ierr)
                call mpi_recv(mymatr, 16, mpi_integer, 1, 0, mpi_comm_world, status, ierr)
            end if
        end if
    end if
    call mpi_barrier(mpi_comm_world, ierr)
    if ((myid .eq. 1) .or. (myid .eq. 2)) then
        do i = 1, 4
            do j = 1, 4
                mytmat(i, j) = mymatr(j, i)
            end do
        end do
    end if
    do i = 1, 4
        write(2, 100) (mytmat(i, j), j = 1, 4)
    end do
    close(1)
    close(2)
    call mpi_finalize(ierr)
end program main
```

### 遇到问题

以下是在登录天河计算机时的界面展示。

```shell
[stu05@ln1%tianhe ~]$ ls
ChenChangyu   les7         result4.log  results.log   results3.log  results6.log  ?????????  ?????????  ?????????  ??????
NPB3.3.1      result1.log  result5.log  results1.log  results4.log  results7.log  ?????????  ??????     ?????????
NPB3.3.1.tgz  result3.log  result6.log  results2.log  results5.log  ?????????     ?????????  ?????????  ??????
[stu05@ln1%tianhe ~]$ cd ChenChangyu
[stu05@ln1%tianhe ChenChangyu]$ ls
MPI-Matrix  example
[stu05@ln1%tianhe ChenChangyu]$ cd example
[stu05@ln1%tianhe example]$ ls
MAT01.TXT  MAT11.TXT  MAT21.TXT  MAT31.TXT  expmtt.f90
[stu05@ln1%tianhe example]$ mpif90 expmtt.f90 -o /ChenChangyu/example/expmtt
ifort: internal error: error generating temporary file name, check disk space and permissions  (shared/driver/hostutil.c, line 853)
[stu05@ln1%tianhe example]$
```

可以看到，编译失败啦！哈哈哈哈哈哈！一开始以为权限不够，于是尝试着更改权限。

```shell
chmod 777 /example
```

现在我的 `example` 文件夹下的所有文件的权限都是 `777`，可读可写可执行，但是问题仍然没有解决。注意，更改权限是很危险的行为，一般不建议使用。

### 解决方案

目前暂时没有找到问题原因，所以也没有什么对应的解决方案。等待一个大佬解答，或者等待我找到原因之时，解决方案将浮出水面。
